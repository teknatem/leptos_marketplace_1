# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏ p902

## ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

–ú–∏–≥—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã `p902_ozon_finance_realization` —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ backend —Å–µ—Ä–≤–µ—Ä–∞!

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend —Å–µ—Ä–≤–µ—Ä:**
   ```bash
   # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π backend (Ctrl+C –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)

   # –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ
   cargo run --bin backend
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**

   –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤—ã —É–≤–∏–¥–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏:
   ```
   WARN  backend::shared::data::db > Migrating p902_ozon_finance_realization table - adding is_return column and updating PRIMARY KEY
   INFO  backend::shared::data::db > Migration of p902_ozon_finance_realization completed successfully
   ```

   –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!

3. **–ì–æ—Ç–æ–≤–æ!**

   –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Ozon - –≤–æ–∑–≤—Ä–∞—Ç—ã –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã `p902_ozon_finance_realization`:

- ‚úÖ –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç —Å—Ç–∞—Ä—É—é —Å—Ö–µ–º—É (–±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ `is_return`) - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ –∏–º–µ–µ—Ç –Ω–æ–≤—É—é —Å—Ö–µ–º—É - –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- ‚úÖ –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π

### –®–∞–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:

1. –°–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `p902_ozon_finance_realization_new` —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
2. –ö–æ–ø–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ (—Å `operation_type='delivery'` –∏ `is_return=0`)
3. –£–¥–∞–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞
4. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è
5. –°–æ–∑–¥–∞—é—Ç—Å—è –∏–Ω–¥–µ–∫—Å—ã –∑–∞–Ω–æ–≤–æ

**–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è!** ‚úÖ

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ö–µ–º–µ:

**–°—Ç–∞—Ä–∞—è —Å—Ö–µ–º–∞:**
```sql
PRIMARY KEY (posting_number, sku)
-- –ë–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ is_return
```

**–ù–æ–≤–∞—è —Å—Ö–µ–º–∞:**
```sql
PRIMARY KEY (posting_number, sku, operation_type)
is_return INTEGER NOT NULL DEFAULT 0
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤:

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Ozon:

### –ü—Ä–æ–¥–∞–∂–∏ (delivery_commission):
- `operation_type = "delivery"`
- `is_return = 0`
- –°—É–º–º—ã **–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ**
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º

### –í–æ–∑–≤—Ä–∞—Ç—ã (return_commission):
- `operation_type = "return"`
- `is_return = 1`
- –°—É–º–º—ã **–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ** (`-quantity`, `-amount`, `-commission`)
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å **–∂–µ–ª—Ç—ã–º —Ñ–æ–Ω–æ–º** –∏ **–∫—Ä–∞—Å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º**

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Ozon. –ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –±—ã–ª–∞ –æ—à–∏–±–∫–∞:
```
UNIQUE constraint failed: p902_ozon_finance_realization.posting_number, p902_ozon_finance_realization.sku
```

–¢–æ —Ç–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫, –∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–∞–∫ –ø—Ä–æ–¥–∞–∂–∏, —Ç–∞–∫ –∏ –≤–æ–∑–≤—Ä–∞—Ç—ã.

## –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ backend
# –£–¥–∞–ª–∏—Ç–µ –ë–î
rm target/db/app.db  # Linux/Mac
del target\db\app.db  # Windows

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ backend - –ë–î –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–Ω–æ–≤–æ —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
cargo run --bin backend
```

---

**–ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è! –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend.** üöÄ
