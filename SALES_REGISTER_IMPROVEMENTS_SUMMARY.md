# Sales Register - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ —É–ª—É—á—à–µ–Ω–∏—è–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã UUID —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–±–∏–Ω–µ—Ç a006_connection_mp
**–ü–æ–ª–µ:** `connection_mp_ref` (TEXT NOT NULL)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ `document.header.connection_id`
- –ò–Ω–¥–µ–∫—Å: `idx_sales_register_connection_mp`

### 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã UUID —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é a002_organization  
**–ü–æ–ª–µ:** `organization_ref` (TEXT NOT NULL)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ `document.header.organization_id`
- –ò–Ω–¥–µ–∫—Å: `idx_sales_register_organization`

### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ UUID —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä a007_marketplace_product
**–ü–æ–ª–µ:** `marketplace_product_ref` (TEXT, nullable)
- –ü–æ–∫–∞ NULL, –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
- –ò–Ω–¥–µ–∫—Å: `idx_sales_register_product`
- TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

### 4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ —Å –¥–∞—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞
**–ü–æ–ª–µ:** `sale_date` (TEXT NOT NULL, —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD)
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ `event_time_source.date_naive()`
- –û—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –±–∏–∑–Ω–µ—Å-–æ—Ç—á–µ—Ç–æ–≤ (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏)
- –ò–Ω–¥–µ–∫—Å: `idx_sales_register_sale_date`

### 5. ‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ source_ref ‚Üí registrator_ref
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
- `registrator_ref` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–±—ã—Ç–∏—è
- –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ raw JSON –≤ `document_raw_storage`

### 6. ‚úÖ –í—Å–µ —Å—Å—ã–ª–∫–∏ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –∫ –µ–¥–∏–Ω–æ–º—É –ø—Ä–∞–≤–∏–ª—É —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º _ref
**–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:**
- `connection_mp_ref` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–±–∏–Ω–µ—Ç –ú–ü
- `organization_ref` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
- `marketplace_product_ref` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä –ú–ü
- `registrator_ref` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ)

### 7. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ SQL —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
–ü–æ–ª—è –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã:
- NK (Natural Key)
- Metadata
- References to aggregates (UUID)
- Timestamps and status
- Product identification
- Quantities and money
- Technical fields

### 8. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã
**8 –∏–Ω–¥–µ–∫—Å–æ–≤** –≤–º–µ—Å—Ç–æ 5:
1. `sale_date` - –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–∞–º
2. `event_time_source` - –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
3. `connection_mp_ref` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º
4. `organization_ref` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º
5. `marketplace_product_ref` - –¥–ª—è —Å–≤—è–∑–∏ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
6. `seller_sku` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
7. `mp_item_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ ID –Ω–∞ –ú–ü
8. `status_norm` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É

### 9. ‚úÖ –£–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã –ø–æ–ª—è –≤ –º–æ–¥–µ–ª–∏
–ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π –≤ `Model` –∏ `SalesRegisterEntry` —Ç–µ–ø–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:
- NK (—Å–Ω–∞—á–∞–ª–∞)
- Metadata
- References
- Timestamps
- Product info
- Money
- Technical

---

## –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å |
|-----------|--------|
| –°—Ö–µ–º–∞ –ë–î (`db.rs`) | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ |
| –ò–Ω–¥–µ–∫—Å—ã –ë–î | ‚úÖ 8 –∏–Ω–¥–µ–∫—Å–æ–≤ —Å–æ–∑–¥–∞–Ω—ã |
| Model (`repository.rs`) | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ |
| SalesRegisterEntry | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ |
| Upsert –º–µ—Ç–æ–¥ | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω |
| Projection –¥–ª—è OZON FBS | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ |
| Projection –¥–ª—è OZON FBO | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ |
| Projection –¥–ª—è Wildberries | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ |
| Projection –¥–ª—è Yandex Market | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ |
| –ö–æ–º–ø–∏–ª—è—Ü–∏—è backend | ‚úÖ –£—Å–ø–µ—à–Ω–∞ |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚úÖ –°–æ–∑–¥–∞–Ω–∞ |

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ò–Ω–¥–µ–∫—Å –ø–æ `sale_date` –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–∞—Ç–∞–º
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ UUID —Å—Å—ã–ª–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ JOIN
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –∏–∑ 8 –∏–Ω–¥–µ–∫—Å–æ–≤

### üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º –ú–ü
- –°–≤—è–∑—å —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –ú–ü (a007)
- –û—Ç–¥–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤

### üõ†Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
- –ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è (_ref)
- –õ–æ–≥–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ–ª–µ–π
- –ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

### üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ú–ü
- –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
- –†–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

---

## –ü—Ä–∏–º–µ—Ä—ã –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

### –û—Ç—á–µ—Ç –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º
```sql
SELECT organization_ref, 
       COUNT(*) as sales_count,
       SUM(qty) as total_items,
       SUM(amount_line) as revenue
FROM p900_sales_register
WHERE sale_date BETWEEN '2025-01-01' AND '2025-01-31'
GROUP BY organization_ref;
```

### –û—Ç—á–µ—Ç –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º
```sql
SELECT connection_mp_ref, marketplace,
       COUNT(*) as sales_count,
       SUM(amount_line) as revenue
FROM p900_sales_register
WHERE sale_date = CURRENT_DATE
GROUP BY connection_mp_ref, marketplace;
```

### –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ –¥–Ω—è–º
```sql
SELECT sale_date,
       COUNT(*) as sales_count,
       SUM(amount_line) as revenue
FROM p900_sales_register
WHERE marketplace = 'OZON'
AND sale_date >= DATE('now', '-30 days')
GROUP BY sale_date
ORDER BY sale_date;
```

### –ü—Ä–æ–¥–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –ú–ü (–ø–æ—Å–ª–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è)
```sql
SELECT sale_date,
       marketplace,
       COUNT(*) as sales_count,
       SUM(qty) as total_qty,
       AVG(price_effective) as avg_price
FROM p900_sales_register
WHERE marketplace_product_ref = '<uuid-—Ç–æ–≤–∞—Ä–∞>'
GROUP BY sale_date, marketplace
ORDER BY sale_date DESC;
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å a007_marketplace_product
**–ó–∞–¥–∞—á–∞:** –ó–∞–ø–æ–ª–Ω–∏—Ç—å `marketplace_product_ref`
**–õ–æ–≥–∏–∫–∞:**
- –ü–æ `seller_sku` + `marketplace` –Ω–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π a007
- –û–±–Ω–æ–≤–∏—Ç—å Sales Register –∑–∞–ø–∏—Å–∏
- –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö

### 2. –°–æ–∑–¥–∞—Ç—å view –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
```sql
CREATE VIEW v_sales_with_product AS
SELECT sr.*,
       mp.product_name,
       mp.category_name,
       org.description as organization_name,
       conn.description as connection_name
FROM p900_sales_register sr
LEFT JOIN a007_marketplace_product mp ON sr.marketplace_product_ref = mp.id
LEFT JOIN a002_organization org ON sr.organization_ref = org.id
LEFT JOIN a006_connection_mp conn ON sr.connection_mp_ref = conn.id;
```

### 3. –î–æ–±–∞–≤–∏—Ç—å API endpoints –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
- `/api/sales/by-date` - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
- `/api/sales/by-organization` - –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º
- `/api/sales/by-connection` - –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º
- `/api/sales/by-product` - –ø–æ —Ç–æ–≤–∞—Ä–∞–º

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. ‚úÖ `crates/backend/src/shared/data/db.rs`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã p900_sales_register
   - –î–æ–±–∞–≤–ª–µ–Ω–æ 8 –∏–Ω–¥–µ–∫—Å–æ–≤
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

2. ‚úÖ `crates/backend/src/projections/p900_mp_sales_register/repository.rs`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Model
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ SalesRegisterEntry
   - –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ upsert_entry

3. ‚úÖ `crates/backend/src/projections/p900_mp_sales_register/projection_builder.rs`
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ 4 —Ñ—É–Ω–∫—Ü–∏–∏ –º–∞–ø–ø–∏–Ω–≥–∞
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è
   - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã –ø–æ–ª—è

4. ‚úÖ `SALES_REGISTER_STRUCTURE_IMPROVEMENTS.md` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
5. ‚úÖ `SALES_REGISTER_IMPROVEMENTS_SUMMARY.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## –ò—Ç–æ–≥–æ

‚úÖ **–í—Å–µ 6 —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω—ã**  
‚úÖ **Backend –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫**  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**  
‚úÖ **–°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**  
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**  

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~1 —á–∞—Å  
**–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 3 –æ—Å–Ω–æ–≤–Ω—ã—Ö + 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~300 –æ–±–Ω–æ–≤–ª–µ–Ω–æ  
**–ò–Ω–¥–µ–∫—Å–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ:** 3 –Ω–æ–≤—ã—Ö (–≤—Å–µ–≥–æ 8)  

