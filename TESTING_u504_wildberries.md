# Диагностика загрузки из Wildberries (U504)

## Проблема
Загружается только 6 и 10 элементов номенклатуры из двух кабинетов Wildberries. Нужно проверить, это все товары или проблема с пагинацией.

## Добавленная диагностика

### 1. В executor.rs
Добавлены подробные логи с визуальным форматированием:
- **Заголовок импорта** - показывает информацию о подключении
- **Информация о каждой странице запроса** - номер страницы, текущий курсор
- **Детали ответа API** - сколько элементов получено, прогресс
- **Статистика обработки** - количество вставленных/обновленных записей
- **Логика пагинации** - причина остановки и состояние курсора

### 2. В wildberries_api_client.rs
Улучшено логирование в файл `wildberries_api_requests.log`:
- Полная информация о cursor (total, updatedAt, nmID)
- Диапазон nmID в каждом батче (первый и последний)
- Предупреждения при пустых ответах

## Как тестировать

### Шаг 1: Запустить backend
```powershell
cd C:\dev\rust\marketplace\leptos_marketplace_1
cargo run --bin backend
```

### Шаг 2: Запустить импорт
Через frontend выполнить импорт из Wildberries для обоих подключений

### Шаг 3: Проверить логи

#### Backend логи (консоль)
Ищите блоки с диагностикой:
```
╔═══════════════════════════════════════════════════════════
║ WILDBERRIES IMPORT DIAGNOSTICS
║ Connection: Название подключения (ID)
╚═══════════════════════════════════════════════════════════
┌─────────────────────────────────────────────────────────
│ Page Request #1 | Cursor: INITIAL REQUEST (no cursor)
│ Cursor in response: nmID=Some(123), updatedAt=..., total=6
│ ✓ API returned TOTAL count: 6 products
│ Response: 6 items received | Total so far: 0/6
│ ✓ Batch processed: 6 inserted, 0 updated
│ → All products received (6/6), no next page needed
└─────────────────────────────────────────────────────────
```

#### Файл wildberries_api_requests.log
Проверьте детали каждого запроса:
```
=== REQUEST ===
POST https://content-api.wildberries.ru/content/v2/get/cards/list
Body: {"settings":{"cursor":{"total":0},"filter":{}},"limit":100}

=== PARSED RESPONSE ===
Items: 6
Cursor.total: 6
Cursor.updatedAt: 2025-09-17T14:52:11.865621Z
Cursor.nmID: Some(504039570)
Product range: first nmID=Some(556499045), last nmID=Some(504039570)
```

## Анализ результатов

### Сценарий 1: Это все товары в кабинете
**Признаки:**
- `Cursor.total` равен количеству полученных товаров
- Логи показывают: `→ All products received (6/6), no next page needed`
- В первом запросе получили все товары

**Вывод:** Проблемы нет, в кабинетах действительно только 6 и 10 товаров.

### Сценарий 2: Проблема с пагинацией
**Признаки:**
- `Cursor.total` > количества полученных товаров
- Пагинация останавливается раньше времени
- Логи показывают: `→ Received X items (less than page_size 100), last page`

**Вывод:** Есть проблема с логикой пагинации, нужна доработка.

### Сценарий 3: Проблема с API ключом или правами
**Признаки:**
- Ошибки авторизации
- Пустые ответы от API
- Статус код не 200

**Вывод:** Проверить API ключ и права доступа в кабинете WB.

## Дополнительные проверки

### Проверить количество товаров вручную
1. Зайти в личный кабинет Wildberries
2. Открыть раздел "Товары"
3. Посчитать общее количество активных товаров
4. Сравнить с `Cursor.total` из логов

### Проверить API ключ
1. Убедиться, что API ключ имеет права на чтение контента
2. Проверить срок действия токена
3. Убедиться, что используется правильный endpoint

## Улучшенная логика пагинации

Код теперь останавливает пагинацию в следующих случаях:

1. **Пустой ответ** - `cards.is_empty()`
2. **Все товары получены** - `total_processed >= expected_total`
3. **Последняя страница** - `batch_size < page_size` (получили меньше чем запросили)
4. **Нет курсора** - API не вернул cursor для следующей страницы

## API Wildberries: cursor-based пагинация

Wildberries API использует курсорную пагинацию:
- **cursor.total** - общее количество товаров
- **cursor.updatedAt** - timestamp последнего обновления
- **cursor.nmID** - ID последнего товара в текущей странице

Для получения следующей страницы нужно отправить курсор из предыдущего ответа.

## Возможные проблемы

1. **API возвращает не все товары**
   - Некоторые товары могут быть скрыты или архивированы
   - Фильтры в API могут исключать часть товаров

2. **Проблема с архивными товарами**
   - Возможно, в кабинете много архивных товаров
   - API может возвращать только активные

3. **Ограничения API ключа**
   - Некоторые API ключи имеют ограниченный доступ
   - Проверить настройки ключа в ЛК WB

## Следующие шаги

После тестирования:
1. Проанализировать логи
2. Определить причину малого количества товаров
3. Если нужно - доработать код или обратиться в поддержку WB API

