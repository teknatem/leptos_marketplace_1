# Исправление зависания страницы a016_ym_returns

**Статус:** ✅ Исправлено (2 этапа)

---

## Проблема

Страница зависала, бесконечно вызывая API сервера.

## Причины (было 2 проблемы!)

### Проблема 1: Двусторонняя синхронизация Effects

- Effect 1 читал `state` и записывал в `RwSignal`
- Effect 2 читал `RwSignal` и записывал в `state`
- → Изменение `state` триггерило Effect 1
- → Изменение `RwSignal` триггерило Effect 2
- → **БЕСКОНЕЧНЫЙ ЦИКЛ!**

### Проблема 2: state.get() в load_data() ⚠️ КРИТИЧНО!

```rust
// ❌ ОПАСНО!
let load_data = move || {
    let current_state = state.get();  // Создаёт реактивность!
    // ...
    state.update(|s| { ... });  // Триггерит цикл!
};

Effect::new(move || {
    load_data();  // Effect становится реактивным на state!
});
```

## Решение

### Исправление 1: Убрали двустороннюю синхронизацию

1. **Удалён Effect для `state → RwSignal`**

   - Оставлен только `RwSignal → state` (одностороннее)

2. **Использовали `untrack()`**

   ```rust
   Effect::new(move || {
       let value = rw_signal.get();
       untrack(move || {
           state.update(|s| s.field = value);
       });
   });
   ```

3. **Инициализация без реактивности**

   ```rust
   let rw_signal = RwSignal::new(state.get_untracked().field);
   ```

4. **Добавлена кнопка "Поиск"**
   - Для явного применения фильтров Return ID и Order ID

### Исправление 2: Исправили load_data() ⚠️ КРИТИЧНО!

```rust
// ✅ ПРАВИЛЬНО!
let load_data = move || {
    let current_state = state.get_untracked();  // Без реактивности!
    // ...
};
```

**Почему критично:** `state.get()` создаёт реактивную зависимость, из-за которой Effect вызывал `load_data()` → `state.update()` → Effect снова → ЦИКЛ!

## Результат

- ✅ Компиляция успешна
- ✅ Нет бесконечного цикла
- ✅ API вызывается только при необходимости
- ✅ Фильтры работают корректно

## Поведение фильтров

| Фильтр        | Как применить               |
| ------------- | --------------------------- |
| **Период**    | Автоматически при изменении |
| **Return ID** | Нажать кнопку "Поиск"       |
| **Order ID**  | Нажать кнопку "Поиск"       |
| **Тип**       | Автоматически при выборе    |

## Проверьте

Откройте: `http://127.0.0.1:8080/?active=a016_ym_returns`

1. Страница загружается без зависания ✅
2. Можно вводить текст в поля фильтра ✅
3. Кнопка "Поиск" применяет фильтры ✅
4. Select типа фильтрует автоматически ✅
5. В DevTools Console нет бесконечных запросов ✅

---

## Важное правило

**❌ НИКОГДА не используйте `state.get()` внутри функций, вызываемых из Effects!**

```rust
// ❌ ОПАСНО
let func = move || state.get();
Effect::new(move || func());

// ✅ БЕЗОПАСНО
let func = move || state.get_untracked();
Effect::new(move || func());
```

---

**Подробная документация:**

- `INFINITE_LOOP_FIX.md` - Первая проблема (двусторонняя синхронизация)
- `CRITICAL_FIX_LOAD_DATA.md` - Вторая проблема (state.get в load_data) ⚠️
