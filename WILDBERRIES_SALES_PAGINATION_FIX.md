# Исправление загрузки всех записей продаж Wildberries

## Проблема

Предыдущая реализация загрузки продаж из Wildberries API (`/api/v1/supplier/sales`) делала только один запрос и получала максимум первую страницу данных (до 100,000 записей). Если записей было больше, остальные данные не загружались.

## Решение

Обновлена функция `fetch_sales` в файле `crates/backend/src/usecases/u504_import_from_wildberries/wildberries_api_client.rs`:

### Что изменено:

1. **Добавлена пагинация через параметр `flag`**:

   - `flag=0` - загрузка первой страницы
   - `flag=1` - загрузка последующих страниц

2. **Цикл загрузки всех записей**:

   - Запросы выполняются в цикле до тех пор, пока API возвращает данные
   - Условия остановки:
     - API вернул пустой массив
     - Получено меньше записей, чем максимальный лимит (100,000)

3. **Логирование процесса**:

   - Детальные логи каждого запроса
   - Счетчик загруженных записей
   - Итоговая статистика

4. **Защита API**:
   - Добавлена задержка 100ms между запросами

### Гарантии:

✓ Загружаются **абсолютно все** записи за указанный период  
✓ Нет дополнительных фильтров (только `dateFrom` и `dateTo`)  
✓ Поддержка больших объемов данных (более 100,000 записей)  
✓ Детальное логирование в `wildberries_api_requests.log`

## Тестирование

### Как проверить:

1. Запустить импорт продаж Wildberries через UI
2. В логах (`wildberries_api_requests.log`) будет видно:
   - Сколько запросов было сделано
   - Сколько записей получено на каждой странице
   - Общее количество загруженных записей

### Пример лога:

```
╔════════════════════════════════════════════════════════════════╗
║ WILDBERRIES SALES API - LOADING ALL RECORDS
║ Period: 2025-01-01 to 2025-01-31
╚════════════════════════════════════════════════════════════════╝

┌────────────────────────────────────────────────────────────┐
│ Request #1 (flag=0)
│ Received: 100000 records
│ Total so far: 100000 records
│ → More records may be available, requesting next page...
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ Request #2 (flag=1)
│ Received: 50000 records
│ Total so far: 150000 records
│ ✓ Received 50000 records (less than limit) - last page
└────────────────────────────────────────────────────────────┘

╔════════════════════════════════════════════════════════════════╗
║ COMPLETED: Loaded 150000 total sale records
╚════════════════════════════════════════════════════════════════╝
```

## Технические детали

### Код:

**Файл**: `crates/backend/src/usecases/u504_import_from_wildberries/wildberries_api_client.rs`

**Функция**: `pub async fn fetch_sales(...) -> Result<Vec<WbSaleRow>>`

**Параметры API**:

- `dateFrom`: дата начала периода (формат: YYYY-MM-DD)
- `dateTo`: дата окончания периода (формат: YYYY-MM-DD)
- `flag`: номер страницы (0 = первая, 1 = последующие)

**Лимиты API**:

- Максимум 100,000 записей за один запрос
- Рекомендуемая задержка между запросами: 100ms

## Дата изменения

2025-11-14
