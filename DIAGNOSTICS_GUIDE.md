# Руководство по диагностике проблем запуска Backend

## Что было добавлено

В backend добавлена подробная диагностика всех критических этапов запуска с проверками:

### 1. **Инициализация логирования** (`system/tracing.rs`)

- Проверка создания директории логов
- Проверка прав на запись в файл логов
- Вывод пути к файлу логов

### 2. **Загрузка конфигурации** (`shared/config.rs`)

- Проверка существования файла `config.toml`
- Проверка размера файла
- Проверка прав доступа (read-only)
- Проверка возможности чтения файла
- Проверка корректности формата TOML
- Вывод содержимого конфигурации

### 3. **Инициализация базы данных** (`shared/data/db.rs`)

- Проверка разрешенного пути к БД
- Проверка существования файла БД
- Проверка/создание родительской директории
- Проверка прав на запись в директорию
- Проверка подключения к SQLite

### 4. **Запуск сервера** (`main.rs`)

- Пошаговый вывод каждого этапа инициализации
- Проверка занятости порта 3000
- Подробные сообщения об ошибках с рекомендациями

## Формат вывода

Все сообщения выводятся с:

- ✓ - успешное выполнение
- ✗ - ошибка
- ℹ - информационное сообщение
- Разделители `========================================`
- Блоки с подробным описанием ошибок и возможных решений

## Как использовать на Windows Server

### Запуск с полной диагностикой

```cmd
backend.exe
```

Программа автоматически выведет детальную информацию о каждом этапе запуска.

### Что проверить, если программа зависает:

1. **После сообщения "CONFIGURATION LOADING DIAGNOSTICS"**

   - Проверьте, есть ли файл `config.toml` рядом с `backend.exe`
   - Убедитесь, что файл не заблокирован антивирусом
   - Проверьте права доступа к файлу

2. **После "DATABASE INITIALIZATION DIAGNOSTICS"**

   - Проверьте путь к БД в `config.toml`
   - Убедитесь, что есть права на создание папки БД
   - Проверьте, что файл БД не заблокирован другим процессом

3. **При ошибке "Port 3000 is already in use"**
   ```cmd
   netstat -ano | findstr :3000
   ```
   Найдите процесс и завершите его в Task Manager

### Пример правильного config.toml

Файл должен находиться в той же папке, что и `backend.exe`:

**Вариант 1: Относительный путь (рекомендуется для портативности)**

```toml
[database]
path = "db/app.db"
```

**Вариант 2: Абсолютный путь с прямыми слешами (рекомендуется)**

```toml
[database]
path = "C:/Users/udv/Desktop/MPI/data/app.db"
```

**Вариант 3: Абсолютный путь с экранированными обратными слешами**

```toml
[database]
path = "C:\\Users\\udv\\Desktop\\MPI\\data\\app.db"
```

**Вариант 4: Абсолютный путь в одинарных кавычках (literal string)**

```toml
[database]
path = 'C:\Users\udv\Desktop\MPI\data\app.db'
```

### ⚠ ВАЖНО: Проблема с обратными слешами в TOML

**НЕПРАВИЛЬНО (вызовет ошибку парсинга):**

```toml
path = "C:\Users\udv\Desktop\MPI\data\app.db"
```

**ПОЧЕМУ:** TOML интерпретирует `\U` как начало Unicode escape-последовательности. Обратные слеши в двойных кавычках требуют экранирования.

**РЕШЕНИЕ:** Используйте **прямые слеши** `/` - Windows их поддерживает! Это самый простой и надежный способ.

### Логи

После успешного запуска логи пишутся в:

- Консоль (с цветами)
- Файл `logs/backend.log` (рядом с exe файлом)

## Типичные проблемы и решения

### Проблема: "Invalid TOML format: invalid unicode 8-digit hex code"

**Полное сообщение:**

```
✗ ERROR: Invalid TOML format: TOML parse error at line X, column Y
invalid unicode 8-digit hex code
```

**Причина:**
Использование обратных слешей Windows `\` в путях внутри двойных кавычек в TOML.

**Пример неправильного config.toml:**

```toml
[database]
path = "C:\Users\udv\Desktop\MPI\data\app.db"  # ❌ НЕПРАВИЛЬНО
```

**Решение:**
Замените обратные слеши на прямые:

```toml
[database]
path = "C:/Users/udv/Desktop/MPI/data/app.db"  # ✓ ПРАВИЛЬНО
```

Windows корректно работает с прямыми слешами в путях!

---

### Проблема: Зависание после "Loading config from"

**Причины:**

- Антивирус блокирует чтение файла
- Файл открыт в редакторе
- Недостаточно прав доступа

**Решение:**

1. Запустите от имени администратора
2. Временно отключите антивирус
3. Закройте файл в редакторе, если он открыт

### Проблема: "Cannot create log directory"

**Причины:**

- Нет прав на создание папок
- Диск заполнен
- Путь содержит недопустимые символы

**Решение:**

1. Запустите от имени администратора
2. Проверьте свободное место на диске
3. Убедитесь, что путь к exe не содержит спецсимволов

### Проблема: "Database connection failed"

**Причины:**

- Файл БД заблокирован другим процессом
- Поврежденный файл БД
- Нет прав на запись

**Решение:**

1. Закройте все другие экземпляры backend.exe
2. Проверьте Task Manager на наличие "висящих" процессов
3. Удалите файл БД и дайте программе создать новый
4. Проверьте права на папку БД

## Запуск для разработки

При разработке используйте:

```cmd
cargo run --bin backend
```

Все диагностические сообщения будут выводиться в консоль.

## Поддержка

При обращении в поддержку приложите:

1. Полный вывод консоли при запуске
2. Содержимое файла `config.toml`
3. Содержимое файла `logs/backend.log`
4. Информацию о Windows Server (версия, права пользователя)
