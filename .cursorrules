# Leptos Marketplace - Project Intelligence for AI

## ğŸ¯ Project Overview

Full-stack Rust marketplace management system integrating with Wildberries and Ozon, powered by 1C:UT11 data.

### UI Design Reference

**bolt-mpi-ui-redesign** (`E:\dev\bolt\bolt-mpi-ui-redesign`) - ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ğ»ĞµĞ¹ UI:
- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾ĞºĞ½Ğ°, Ñ„Ğ¾Ñ€Ğ¼Ñ‹, ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
- Ğ¡Ñ‚Ğ¸Ğ»Ğ¸: `public/themes/base.css`, `dark.css`, `light.css`
- ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹: input height 30px, padding 5px 12px

## ğŸ—ï¸ Architecture Quick Reference

### Tech Stack

- **Frontend**: Leptos 0.6 (Rust â†’ WASM)
- **Backend**: Axum (async Rust)
- **Database**: SQLite (marketplace.db)
- **Architecture**: DDD + Vertical Slice Architecture (VSA)
- **Workspace**: 3 crates (contracts, backend, frontend)

### Critical Structure

```
crates/
â”œâ”€â”€ contracts/    # Shared DTOs & types between frontend/backend
â”œâ”€â”€ backend/      # Axum server, domain logic, repositories
â””â”€â”€ frontend/     # Leptos UI components
```

## ğŸ“¦ Naming System (CRITICAL)

This project uses indexed naming for features:

### Aggregates: `a001-a499` (Domain entities)

- `a001_connection_1c` - 1C connections
- `a002_organization` - Organizations
- `a003_product` - Products
- `a004_nomenclature` - Nomenclature
- `a014_ozon_transactions` - Ozon transactions
- `a015_wb_orders` - Wildberries orders

### UseCases: `u501-u999` (Operations)

- `u501_import_from_ut` - Import from 1C:UT11
- `u504_import_from_wildberries` - WB integration
- `u505_import_from_ozon` - Ozon integration
- `u506_import_from_lemanapro` - LemanaPro integration

### Projections: `p901-p999` (Read models/analytics)

- `p902_sales_register` - Sales register
- `p903_wb_finance_report` - WB finance report
- `p904_sales_data` - Sales analytics
- `p905_wb_commission_history` - WB commissions

### System Tables: `sys_*` (System infrastructure)

- `sys_users` - User accounts
- `sys_refresh_tokens` - JWT refresh tokens
- `sys_audit_log` - Audit trail
- `sys_settings` - System-wide settings

**File Structure Example:**

```
crates/backend/src/domain/a001_connection_1c/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ service.rs       # Business logic orchestration
â””â”€â”€ repository.rs    # Database CRUD operations

crates/backend/src/system/          # System functionality (auth, users, etc.)
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ jwt.rs
â”‚   â”œâ”€â”€ password.rs
â”‚   â”œâ”€â”€ middleware.rs
â”‚   â””â”€â”€ extractor.rs
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ repository.rs
â”‚   â””â”€â”€ service.rs
â””â”€â”€ handlers/
    â”œâ”€â”€ auth.rs
    â””â”€â”€ users.rs

crates/frontend/src/domain/a001_connection_1c/ui/
â”œâ”€â”€ list/           # List view
â””â”€â”€ details/        # Details view

crates/frontend/src/system/         # System UI (login, user management)
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ context.rs
â”‚   â”œâ”€â”€ guard.rs
â”‚   â””â”€â”€ api.rs
â”œâ”€â”€ users/ui/
â”‚   â”œâ”€â”€ list/
â”‚   â””â”€â”€ details/
â””â”€â”€ pages/
    â””â”€â”€ login.rs
```

## ğŸ”‘ Critical Patterns

### 1. Domain Layer Rules (See: memory-bank/architecture/domain-layer-architecture.md)

- **repository.rs**: ONLY database CRUD, NO business logic
- **service.rs**: Orchestrates operations, calls validators, business rules
- **aggregate.rs**: Data structure + simple instance methods
- **events.rs**: Complex validation/lifecycle handlers (optional, only if needed)

### 2. Lifecycle Events (1C-style)

```rust
// Create/Update flow:
1. validate()       // Can block operation
2. before_write()   // Can modify data
3. service logic    // Business rules
4. repository::save()

// Delete flow:
1. before_delete()  // Can block operation
2. repository::soft_delete()
```

### 3. Layer Communication

```
Handlers â†’ Service â†’ Repository â†’ Database
         â†˜ UseCases (for multi-aggregate operations)
```

**DON'T**: Call repository directly from handlers
**DO**: Always go through service layer

## ğŸš¨ Environment-Specific Rules

### Windows Environment

- **Shell**: PowerShell (NOT bash)
- **Command chaining**: Use semicolons `;` or separate commands, NEVER use `&&`
- **Node.js**: Use `pnpm` (not npm/yarn)

### Development Commands

```powershell
# Backend
cargo run --bin backend

# Frontend (development)
trunk serve --port 8080

# Frontend (production build)
trunk build --release

# Database migrations
# Run .sql files manually or via migrate_db.py
```

## ğŸ“Š Database Patterns

### Table Naming

- Aggregates: `a001_connection_1c_database`
- UseCases history: `u501_import_history`
- Projections: `p904_sales_data`

### Common Fields

```sql
id TEXT PRIMARY KEY,           -- UUID or auto-increment
code TEXT,                     -- Business key
description TEXT,              -- Display name
created_at TEXT,               -- ISO timestamp
updated_at TEXT,               -- ISO timestamp
is_deleted INTEGER DEFAULT 0   -- Soft delete flag
```

## ğŸ¨ Frontend Patterns

### Component Structure

```
domain/{feature}/ui/
â”œâ”€â”€ list/
â”‚   â””â”€â”€ mod.rs       # List view with table
â””â”€â”€ details/
    â””â”€â”€ mod.rs       # Details/edit form
```

### Common Utilities

- `shared/list_utils.rs` - Table sorting, filtering helpers
- `shared/table_utils.rs` - Column resize with localStorage persistence
- `shared/date_utils.rs` - Date formatting
- `layout/center/tabs/tabs.rs` - Tab management

### Styling

- CSS in `frontend/styles/3-components/`
- Use existing table classes, form patterns
- Consistent UI: tabs, filters, date pickers

### List Standard (IMPORTANT)

- See: `memory-bank/architecture/list-standard.md` for complete specification
- Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½: `a012_wb_sales` - ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ°Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ, resize ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº, Ñ‡ĞµĞºĞ±Ğ¾ĞºÑÑ‹
- Ğ’ÑĞµ ÑĞ¿Ğ¸ÑĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑ€Ğ²ĞµÑ€Ğ½ÑƒÑ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ (offset/limit)

## ğŸ” Authentication System

- **JWT-based**: Access tokens (24h) + Refresh tokens (90 days)
- **Multi-user**: Stored in `sys_users` table
- **First run**: Auto-creates `admin/admin` user
- **Middleware**: `system::auth::middleware::require_auth` and `require_admin`
- **Frontend**: AuthProvider context, RequireAuth/RequireAdmin guards
- **Tokens**: Stored in localStorage on frontend

## ğŸ” Key Files to Reference

### Architecture

- `memory-bank/architecture/domain-layer-architecture.md` - Domain layer rules
- `memory-bank/architecture/naming-conventions.md` - Complete naming guide
- `memory-bank/architecture/project-structure.md` - Workspace structure
- `memory-bank/architecture/list-standard.md` - List component standard (Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ, resize, Ñ‡ĞµĞºĞ±Ğ¾ĞºÑÑ‹)
- `memory-bank/architecture/modal-ui-standard.md` - Modal & Forms UI standard (ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ²Ğ²ĞµÑ€Ñ…Ñƒ, glassmorphism)

### Active Work

- `memory-bank/activeContext.md` - Current focus & recent changes
- `memory-bank/progress.md` - What works, what's left

## ğŸ’¡ Project Intelligence

### Code Quality Rules

- Max 2-3 levels of nesting
- Early return instead of deep conditionals
- Extract nested logic into separate functions
- Use `match` and combinators (`map`, `and_then`) over nested if-else

### Common Gotchas

1. **Aggregates vs Projections**: Aggregates are write models (transactional), Projections are read models (analytics)
2. **Service vs UseCase**: Service handles single aggregate, UseCase coordinates multiple aggregates
3. **Repository simplicity**: Keep it dumb - just CRUD, no business rules
4. **Soft deletes**: Use `is_deleted` flag, don't hard delete aggregates

### Integration Notes

- **Wildberries API**: Token-based, stored in connection settings
- **Ozon API**: Client ID + API Key
- **1C OData**: Basic auth, standard OData v4 protocol

## ğŸ“ Documentation Updates

When updating memory bank (user command: "update memory bank"):

1. Read ALL 5 core files first
2. Update `activeContext.md` - current focus
3. Update `progress.md` - what's done, what's left
4. Update this `.cursorrules` if discovering new patterns
5. Update architecture docs only if patterns changed

## ğŸ¯ Current Project Status (2025-11-26)

**Working Features:**

- âœ… 1C integration (u501)
- âœ… Wildberries integration (u504)
- âœ… Ozon integration (u505)
- âœ… Sales analytics (p904)
- âœ… WB commission history (p905)
- âœ… Ozon transactions (a014)

**Known Issues:**

- Check `memory-bank/progress.md` for active issues

---

**Memory Bank Location**: `memory-bank/`
**For detailed context**: Always start with 5 core files in memory-bank/
